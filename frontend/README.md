# 前端架构文档

本文档详细介绍游戏前端模块的架构设计与实现。

## 整体架构

前端基于Pygame实现，采用MVC（Model-View-Controller）架构模式，结合状态机管理和事件驱动通信。整体分为以下几个核心模块：

- **核心引擎模块** (`core/`): 游戏主控制器、渲染引擎、动画系统
- **用户界面模块** (`ui/`): 游戏界面组件和交互元素
- **配置模块** (`config/`): 数据结构和配置管理
- **工具模块** (`util/`): 通用工具和常量定义

## 核心模块详解

### 游戏客户端模块 (`core/game_client.py`)

**功能职责：**
- 作为前端的主要控制器，负责事件处理和路由
- 管理游戏状态机（等待、动画中、选择中、暂停、结束）
- 协调动画系统和视觉反馈
- 处理与后端的事件通信和确认机制

**主要函数：**
- `__init__()`: 初始化游戏客户端、渲染器、动画管理器
- `process_events()`: 处理从后端接收的事件队列
- `handle_*_event()`: 处理各类游戏事件（摸牌、出牌、血量变化等）
- `start_*_animation()`: 启动相应的动画效果
- `send_ack()`: 向后端发送事件确认

### 渲染引擎模块 (`core/renderer.py`)

**功能职责：**
- 管理所有视觉组件的渲染和布局
- 处理窗口缩放和响应式布局更新
- 管理sprite层级和绘制顺序
- 提供UI元素位置计算

**主要函数：**
- `__init__()`: 初始化渲染窗口和sprite组
- `update_layout()`: 更新布局以适应窗口大小变化
- `get_*_position()`: 计算各UI元素的位置坐标
- `get_player_at_position()`: 根据坐标获取对应玩家
- `render()`: 执行主要渲染循环

### 动画管理器 (`core/animation_manager.py`)

**功能职责：**
- 实现平滑的卡牌移动动画
- 管理游戏动作的视觉特效
- 提供基于回调的动画完成处理
- 管理动画期间的状态转换

**主要函数：**
- `animate_card_movement()`: 卡牌移动动画
- `show_effect()`: 显示视觉特效
- `update()`: 更新所有动画状态
- `is_animating()`: 检查是否正在播放动画

**数据：**
- 活动动画列表、特效sprite、回调函数队列

### 资源管理器 (`core/asset_manager.py`)

**功能职责：**
- 实现资源的懒加载和缓存机制
- 支持多种资源类型（卡牌、角色、特效）
- 处理缺失资源的降级
- 提供跨平台的资源路径管理

**主要函数：**
- `load_card_image()`: 加载卡牌图像
- `load_character_portrait()`: 加载角色头像
- `load_effect_image()`: 加载特效图像

## 用户界面模块

### 开始界面 (`ui/start_screen.py`)

**功能职责：**
- 提供游戏启动菜单
- 支持配置文件选择功能（待完成）
- 集成Tkinter文件对话框
- 随机游戏生成选项

**主要函数：**
- `__init__()`: 初始化开始界面
- `select_config_file()`: 打开文件选择对话框
- `start_random_game()`: 启动随机配置游戏
- `show()`: 显示开始界面

### 玩家视图 (`ui/player_view.py`)

**功能职责：**
- 完整的玩家信息展示
- 角色头像和血量条显示
- 装备区域和手牌管理
- 主公标记和死亡效果

**主要函数：**
- `__init__()`: 初始化玩家视图
- `update_hp()`: 更新血量显示
- `add_card()`: 添加手牌
- `remove_card()`: 移除手牌
- `equip_*()`: 装备各类装备
- `show_death_effect()`: 显示死亡效果

### 卡牌视图 (`ui/card_view.py`)

**功能职责：**
- 卡牌显示组件
- 卡牌属性集成
- 位置管理和渲染

### 卡牌sprite (`ui/card_sprite.py`)

**功能职责：**
- 带动画效果的卡牌sprite
- 位置插值和移动动画
- 视觉状态管理

### 特效sprite (`ui/effect_sprite.py`)

**功能职责：**
- 游戏特效的视觉反馈
- 时间控制和自动清理

## 配置模块

### 卡牌配置 (`config/card_config.py`)

**数据结构：**
- 卡牌名称、花色、点数属性
- 卡牌比较和匹配功能

### 玩家配置 (`config/player_config.py`)

**数据结构：**
- 角色、身份、控制类型设置
- 血量和装备配置

## 工具模块

### 颜色定义 (`util/color.py`)

**功能：**
- 统一的颜色调色板定义
- UI元素和游戏状态的颜色映射

### 字体管理 (`util/fonts.py`)

**功能：**
- 跨平台中文字体支持
- 多种字体尺寸和回退机制
- 特殊字体（隶书）支持

### 尺寸常量 (`util/size.py`)

**功能：**
- 标准尺寸定义（窗口、卡牌、UI元素）
- 布局计算常量

## 前后端通信架构

### 通信机制

通过`communicator`模块实现前后端通信：

1. **事件队列系统：**
   - `backend→frontend`队列：`btf_queue`
   - `frontend→backend`队列：`ftb_queue`

2. **处理的事件类型：**
   - `DrawCardEvent`：摸牌动画，更新手牌
   - `PlayCardEvent`：出牌和目标选择
   - `HPChangeEvent`：血量条更新
   - `DiscardCardEvent`：弃牌事件
   - `EquipChangeEvent`：装备更新
   - `DeathEvent`：玩家死亡

3. **确认机制：**
   - 异步确认处理
   - 事件成功/失败状态反馈
   - 通信超时处理

### 通信流程

```
前端 ←→ 通信器 ←→ 后端
  ↓        ↓         ↓
游戏事件  事件队列   游戏逻辑
  ↓        ↓         ↓
动画效果  状态更新   配置管理
```

## 架构特点与设计模式

### 1. 状态管理模式
- **游戏状态机**：使用`GameStateEnum`进行状态转换
- **集中状态管理**：`game_state`单例模式管理全局状态
- **事件驱动**：由后端事件触发前端动作

### 2. 渲染架构
- **脏矩形渲染**：使用`pygame.sprite.DirtySprite`提升性能
- **分层管理**：sprite层级确保正确的绘制顺序
- **响应式布局**：动态位置计算适应不同屏幕尺寸

### 3. 动画系统
- **插值动画**：平滑的卡牌移动插值
- **回调机制**：动画完成回调进行状态更新
- **特效管理**：定时视觉效果和自动清理

### 4. 资源管理
- **懒加载**：按需加载资源并缓存
- **回退系统**：处理缺失资源
- **跨平台支持**：跨平台字体和路径处理

### 5. 事件处理
- **线程安全通信**：基于队列的事件传递
- **确认模式**：确保可靠的事件处理
- **错误处理**：优雅处理通信故障